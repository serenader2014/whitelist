.wl-sidebar-wrapper
    .wl-sidebar
        - each parent,index in parents
            .wl-parents-hidden.wl-sidebar-product(class='wl-parents-#{index}')
                .content
                    .wl-product-count 总计 #{parent.current.pcount} 个子产品
                    ul
                        - each product in parent.product
                            - var c = '';
                            - if (product.name === current.current.name || (parents[index+1] && product.name === parents[index+1].current.name))
                                - c = 'active'
                            li(class='#{c}', data-id='#{product.id}')
                                .wl-product-info
                                    - var weight = product.weight*1 > 1000000 ? Math.floor(product.weight/1000000) + ' M' : (product.weight*1 > 1000 ? Math.floor(product.weight/1000) + ' K' : product.weight)
                                    - var num = product.pcount*1 > 1000000 ? Math.floor(product.pcount/1000000) + ' M' : (product.pcount*1 > 1000 ? Math.floor(product.pcount/1000) + ' K' : product.pcount)
                                    span.wl-product-weight #{weight}
                                    span.wl-product-amount #{num}
                                a(href='/#{urlArr[index+1]}/#{product.name}') #{product.name} 
                    - if (parent.current.pcount > 100)
                        - var str = urlArr[index+1]
                        .wl-more-product(data-current='#{str}')
                            span.progress
                            span More
                .slide-btn: a(href='javascript:;')
        - if (!search && !sort)
            .wl-current-product.wl-sidebar-product
                .content.expanded
                    .wl-product-count 总计 #{current.current.pcount} 个子产品
                    ul
                        - each product in current.product
                            li(data-id='#{product.id}')
                                .wl-product-info
                                    - var num = product.pcount*1 > 1000000 ? Math.floor(product.pcount/1000000) + ' M' : (product.pcount*1 > 1000 ? Math.floor(product.pcount/1000) + ' K' : product.pcount)
                                    - var weight = product.weight*1 > 1000000 ? Math.floor(product.weight/1000000) + ' M' : (product.weight*1 > 1000 ? Math.floor(product.weight/1000) + ' K' : product.weight)
                                    span.wl-product-weight #{weight}
                                    span.wl-product-amount #{num}
                                span.message-btn.icon-pencil
                                a(href='/#{urlArr[urlArr.length-1]}/#{product.name}') #{product.name} 
                                .message-popup
                                    .popup-wrapper
                                        textarea #{product.remark}
                                        button(type='submit') Submit                            
                    - if (current.current.pcount > 100)
                        - var str = urlArr[urlArr.length-1]
                        .wl-more-product(data-current='#{str}') 
                            span.progress
                            span More
                .slide-btn: a.fold(href='javascript:;') 



    .wl-main
        .wl-sort
            .wl-sort-container
                p 按首字母排序
                .wl-sort-letter
                    - each num,letter in current.first_letter
                        - if (num*1 > 0)
                            span: a(href='/#{urlArr[urlArr.length-1]}?search=#{letter}%') #{letter} (#{num})
        - if (search || sort)
            - var header = sort ? '按首字母 '+sort+' 排序' : '搜索 '+ search +' 的结果'
            h2.wl-query-header #{header}
            .product-wrapper
                table.wl-table
                    thead
                        tr.wl-tr
                            th product 
                            th weight
                            th num
                            th.th-remark remark
                            th product 
                            th weight
                            th num
                            th.th-remark remark
                    tbody.wl-tbody
                        - current.product.forEach(function (item,index) {
                            - if(index%2 === 0) {
                                tr
                            - }
                                    td  
                                        span.message-btn.icon-pencil
                                        a.product(href='/#{urlArr[urlArr.length-1]}/#{item.name}',data-id='#{item.id}') #{item.name}
                                        .message-popup
                                            .popup-wrapper
                                                textarea #{item.remark}
                                                button(type='submit') Submit 
                                    td #{item.weight}
                                    td #{item.count}
                                    td.td-remark #{item.remark}
                        - })            
        - else
            .ip-wrapper
                - each ip in ips
                    - var c = ip.safe === 1 ? 'safe' : 'danger' 
                    .ip(data-id='#{ip.id}', class='#{c}')
                        span.message-btn.icon-pencil
                        span.mark-unsafe.icon-pushpin
                        span.ip-value #{ip.value}
                        span.ip-weight #{ip.weight}
                        .message-popup
                            .popup-wrapper
                                textarea #{ip.remark}
                                button(type='submit') Submit
    script.
        $('.wl-main').width($('body').width()-$('.wl-sidebar').width());
        $('.slide-btn a').on('click', function (event) {
            var self = this;
            var p = $(self).parents('.wl-sidebar-product');
            var content = p.find('.content');
            var sidebarWidth = $('.wl-sidebar').width();
            var bodyWidth = $(document).width();

            if (content.hasClass('expanded')) {
                content.removeClass('expanded');
                $(self).removeClass('fold');
                $('.wl-main').animate({
                    width: bodyWidth - sidebarWidth + 375 + 'px'
                }, 300);
            } else {
                if (sidebarWidth<375) {
                    $('.wl-main').width(bodyWidth - sidebarWidth - 375);
                } else {
                    $('.wl-main').width(bodyWidth - sidebarWidth);
                }
                content.addClass('expanded');
                $(self).addClass('fold');
                p.siblings().find('.content').removeClass('expanded');
                p.siblings().find('.slide-btn a').removeClass('fold');
            }
        });
        $('.message-btn').on('click', function () {
            $(this).siblings('.message-popup').fadeIn(300);
        });
        $(document).on('click', function (event) {
            if (! $(event.target).hasClass('message-btn') && $(event.target).parents('.message-popup').length === 0) {
                if ($('.message-popup').is(':visible')) {
                    $('.message-popup').fadeOut(300);
                }
            }
        });
        $('.message-popup button').on('click', function () {
            var type,id,targetUrl;
            var self = this;
            if ($(this).parents('.ip').length > 0) {
                type = 'ip';
                id = $(this).parents('.ip').data('id');

                targetUrl = '/set';
                $.ajax({
                    type: 'POST',
                    url: targetUrl,
                    data: {
                        description: $(self).siblings('textarea').val(),
                        id: id,
                        type: type
                    },
                    success: function (data) {
                        data = $.parseJSON(data);
                        $(self).siblings('textarea').html(data.data.remark).val(data.data.remark);
                    }
                });
            }
        });

        $('.mark-unsafe').on('click', function () {
            var type,id,targetUrl;
            var self = this;
            if ($(this).parents('.ip').length > 0) {
                type = 'ip';
                id = $(this).parents('.ip').data('id');

                targetUrl = '/set';
                $.ajax({
                    type: 'POST',
                    url: targetUrl,
                    data: {
                        safe: $(self).parents('.ip').hasClass('safe') ? 0 : 1,
                        id: id,
                        type: type
                    },
                    success: function (data) {
                        data = $.parseJSON(data);
                        if (data.data.safe == 1) {
                            $(self).parents('.ip').addClass('safe').removeClass('danger');
                        } else {
                            $(self).parents('.ip').addClass('danger').removeClass('safe');
                        }
                    }

                })
            }
        });

        $('.wl-more-product').on('click', function () {
            var currentLength = $(this).siblings('ul').find('li').length;
            var total = $(this).siblings('.wl-product-count').html().split(' ')[1]*1;
            var targetUrl = '/single/' + $(this).data('current') + '?limit=100&offset=' + currentLength;
            
            $(this).find('.progress').addClass('icon-spinner2');
            var self = this;

            $.ajax({
                type: 'GET',
                url: targetUrl,
                success: function (data) {
                    data = $.parseJSON(data);
                    console.log(data);
                    $(self).find('.progress').removeClass('icon-spinner2');
                }
            });
        });
